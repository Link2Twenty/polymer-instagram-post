<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="instagram-post">
  <template>
    <style>
      :host {
        display: block;
      }
      .instagram-post {
        background:#FFF;
        border:0;
        border-radius:3px;
        box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15);
        margin: 1px;
        max-width:658px;
        padding:0;
        width:99.375%;
        width:-webkit-calc(100% - 2px);
        width:calc(100% - 2px);
      }
      .instagram-header {
        -webkit-box-align: center;
        -webkit-align-items: center;
        -ms-flex-align: center;
        align-items: center;
        display: -webkit-box;
        display: -webkit-flex;
        display: ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -webkit-flex-direction: row;
        -ms-flex-direction: row;
        flex-direction: row;
        height: 34px;
        padding: 10px;
      }
      .instagram-avatar img{
        border-radius: 50%;
        height: 30px;
      }
      .instagram-username {
        -webkit-box-align: center;
        -webkit-align-items: center;
        -ms-flex-align: center;
        align-items: center;
        display: -webkit-box;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -webkit-flex-direction: row;
        -ms-flex-direction: row;
        flex-direction: row;
        font-weight: 600;
        color: #262626;
        text-decoration: none;
        padding: 0 10px;
      }
      .instagram-verified {
        display: inline-block;
        height: 12px;
        width: 12px;
        overflow: hidden;
        background-position: -50px -25px;
        background-image: url(https://www.instagram.com/static/bundles/sprite_embednew_2x.png/f8cfa266e12d.png);
        background-size: 74px 49px;
      }
      .instagram-image {
        width:100%;
      }
      .instagram-temp {
        background:#F8F8F8;
        line-height:0;
        padding:62.5% 0;
        text-align:center;
        width:100%;
      }
      .instagram-logo {
        background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC);
        display:block;
        height:44px;
        margin:0 auto -44px;
        position:relative;
        top:-22px;
        width:44px;
      }
      .instagram-textbox {
        margin:8px 0 0 0;
        padding:0 10px;
      }
      .instagram-text {
        color:#000;
        font-size:14px;
        font-style:normal;
        font-weight:normal;
        line-height:17px;
        text-decoration:none;
        word-wrap:break-word;
      }
      .instagram-author {
        color:#262626;
        font-family:Arial,sans-serif;
        font-size:14px;
        font-weight: 600;
        font-style:normal;
        line-height:17px;
      }
      .instagram-time {
        font-family:Arial,sans-serif;
        font-size:14px;
        line-height:17px;
      }
      .bolded {
        font-weight: 600;
      }
    </style>

    <blockquote class="instagram-post">
      <div class="instagram-header">
        <a class="instagram-avatar" href$=[[authorUrl]] target="_blank">
          <img src$=[[authorAvatar]] alt$=[[authorId]]>
        </a>
        <a class="instagram-username" href$=[[authorUrl]] target="_blank">
          [[authorId]]
        </a>
        <span class="instagram-verified">
        </span>
      </div>
      <div>
        <a href$=[[instagramUrl]]>
          <img class="instagram-image"  hidden$=[[!loaded]] src$=[[imgSrc]]>
        </a>
        <div class="instagram-temp" hidden$=[[loaded]]>
          <div class="instagram-logo"></div>
        </div>
        <p class="instagram-textbox">
          <a class="instagram-text bolded" href$=[[instagramUrl]] target="_blank">[[likes]] likes</a>
        </p>
        <p class="instagram-textbox">
          <a href$=[[authorUrl]] class="instagram-author" target="_blank">[[authorId]]</a> <a class="instagram-text" href$=[[instagramUrl]] target="_blank">[[instagramText]]</a>
        </p>
        </div>
      </blockquote>
  </template>

  <script>
    /**
     * `instagram-post`
     * Display an Instagram post in your Polymer website
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class InstagramPost extends Polymer.Element {
      static get is() { return 'instagram-post'; }
      static get properties() {
        return {
          ajaxResponse: {
            type: Object
          },
          postid: {
            type: String
          },
          imgSrc: {
            type: String
          },
          instagramUrl: {
            type: String,
            computed: '_buildUrl(postid)',
            observer: '_getInstagramAPI'
          },
          authorUrl: {
            type: String,
            computed: '_computeAuthorUrl(authorId)'
          },
          authorName: {
            type: String
          },
          authorId: {
            type: String
          },
          authorAvatar: {
            type: String
          },
          instagramText: {
            type: String
          },
          likes: {
            type: String
          },
          timestamp: {
            type: Number
          },
          humanDate: {
            type: String,
            computed: '_computeHumanDate(timestamp)'
          },
          loaded: {
            type: Boolean,
            value: false
          }
        };
      }

      _computeAuthorUrl(authorId) {
        return 'https://www.instagram.com/' + authorId;
      }

      _computeHumanDate(timestamp) {
        return new Date(timestamp*1000);
      }

      _getInstagramAPI(instagramUrl) {
        var xhr = new XMLHttpRequest();
        xhr.addEventListener("load", (e) => {
          console.log(e.target);
          if (e.target.status == 200) {
            let responseObj = JSON.parse(e.target.response);
            let graphql = responseObj.graphql.shortcode_media;
            console.log(responseObj);
            this.set('instagramText', graphql.edge_media_to_caption.edges[0].node.text);
            this.set('imgSrc', graphql.display_url);
            this.set('authorId', graphql.owner.username);
            this.set('authorName', graphql.owner.full_name);
            this.set('timestamp', graphql.taken_at_timestamp);
            this.set('authorAvatar', graphql.owner.profile_pic_url);
            this.set('likes', graphql.edge_media_preview_like.count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","))
            this.set('loaded', true);
          }
        });
        console.log(this.instagramUrl + "/?__a=1");
        xhr.open("GET", "https://cors.io/?" + this.instagramUrl + "/?__a=1");
        xhr.send();
      }

      _buildUrl(postid) {
        return 'https://www.instagram.com/p/' + postid;
      }

      connectedCallback() {
        super.connectedCallback();
      }
    }

    window.customElements.define(InstagramPost.is, InstagramPost);
  </script>
</dom-module>
